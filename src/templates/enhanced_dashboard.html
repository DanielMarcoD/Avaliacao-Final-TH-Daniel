<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Security Scanner - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0 !important; padding: 0 !important; }
        .dashboard-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; 
            color: white !important;
            min-height: 60px !important;
            height: auto !important;
            z-index: 1030 !important;
            position: static !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
        }
        .navbar {
            display: block !important;
            visibility: visible !important;
            margin-bottom: 0 !important;
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .navbar-text {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        .stat-card { border-left: 4px solid #007bff; }
        .vulnerability-badge { font-size: 0.8em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark dashboard-header" style="display: block !important; visibility: visible !important;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="color: white !important;">
                <i class="fas fa-shield-alt"></i> Enhanced Security Scanner
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3" style="color: rgba(255, 255, 255, 0.9) !important;">
                        Welcome, {{ username or 'User' }}
                    </span>
                    {% if is_admin %}
                    <a class="btn btn-outline-warning btn-sm me-2" href="/admin">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    {% endif %}
                    <a class="btn btn-outline-light btn-sm" href="/logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-search text-primary"></i> Total Scans</h5>
                        <h2 class="text-primary">{{ stats[0] or 0 }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-bug text-danger"></i> Vulnerabilities Found</h5>
                        <h2 class="text-danger">{{ stats[1] or 0 }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-line text-warning"></i> Avg Risk Score</h5>
                        <h2 class="text-warning">{{ "%.1f"|format(stats[2] or 0) }}/10</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Scan Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Start New Enhanced Scan</h5>
            </div>
            <div class="card-body">
                <form id="scanForm">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="targetUrl" class="form-label">
                                <i class="fas fa-link"></i> Target URL
                            </label>
                            <input type="url" class="form-control" id="targetUrl" 
                                   placeholder="https://example.com" required>
                            <small class="form-text text-muted">Enter the full URL of the website to scan</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="timeout" class="form-label">
                                <i class="fas fa-clock"></i> Request Timeout (seconds)
                            </label>
                            <input type="number" class="form-control" id="timeout" 
                                   placeholder="120" value="120" min="10" max="300">
                            <small class="form-text text-muted">Time limit for each request</small>
                        </div>
                        <div class="col-md-4">
                            <label for="maxPaths" class="form-label">
                                <i class="fas fa-sitemap"></i> Max Paths to Scan
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="maxPaths" 
                                       placeholder="-1" value="-1" min="-1" max="500">
                                <button class="btn btn-warning" type="button" id="unlimitedBtn" 
                                        onclick="toggleUnlimited()" title="Enable Unlimited Paths">
                                    <i class="fas fa-infinity"></i> Unlimited
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <span id="pathsHint" style="display: none;">Maximum number of paths (1-500)</span>
                                <span id="unlimitedWarning" class="text-warning">
                                    <i class="fas fa-infinity"></i> All paths (default)
                                </span>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label for="maxScanTime" class="form-label">
                                <i class="fas fa-hourglass-half"></i> Max Total Scan Time (minutes)
                            </label>
                            <input type="number" class="form-control" id="maxScanTime" 
                                   placeholder="Optional" value="" min="1" max="180">
                            <small class="form-text text-muted">Leave empty for no limit</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-play"></i> Start Enhanced Scan
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-pie"></i> Vulnerability Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="vulnerabilityChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line"></i> Risk Trend</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="riskChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Scans -->
        <div id="activeScans"></div>

        <!-- Recent Scans with Filters -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-history"></i> Recent Scans</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterScans('all')">All</button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterScans('completed')">Completed</button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterScans('running')">Running</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="filterScans('failed')">Failed</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Scan ID</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Vulnerabilities</th>
                                <th>Risk Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scanHistory">
                            {% for scan in recent_scans %}
                            <tr>
                                <td><code>{{ scan[0] }}</code></td>
                                <td>{{ scan[1] }}</td>
                                <td>
                                    {% if scan[2] == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif scan[2] == 'running' %}
                                        <span class="badge bg-primary">Running</span>
                                    {% elif scan[2] == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ scan[2] }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ scan[3] }}</td>
                                <td>
                                    {% if scan[4] > 0 %}
                                        <span class="badge bg-danger">{{ scan[4] }}</span>
                                    {% else %}
                                        <span class="badge bg-success">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if scan[5] %}
                                        <span class="badge bg-warning">{{ "%.1f"|format(scan[5]) }}/10</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if scan[2] == 'completed' %}
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="downloadReport('{{ scan[0] }}', 'json')" title="Download JSON">
                                            <i class="fas fa-file-code"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="downloadReport('{{ scan[0] }}', 'csv')" title="Download CSV">
                                            <i class="fas fa-file-excel"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="downloadReport('{{ scan[0] }}', 'markdown')" title="Download Markdown">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variable to track unlimited mode - default is TRUE (unlimited)
        let isUnlimitedMode = true;
        
        // Toggle unlimited paths mode
        function toggleUnlimited() {
            const maxPathsInput = document.getElementById('maxPaths');
            const unlimitedBtn = document.getElementById('unlimitedBtn');
            const pathsHint = document.getElementById('pathsHint');
            const unlimitedWarning = document.getElementById('unlimitedWarning');
            
            isUnlimitedMode = !isUnlimitedMode;
            
            if (isUnlimitedMode) {
                // Enable unlimited mode
                maxPathsInput.value = -1;  // -1 means unlimited
                maxPathsInput.disabled = true;
                maxPathsInput.style.backgroundColor = '#fff3cd';
                unlimitedBtn.classList.remove('btn-outline-warning');
                unlimitedBtn.classList.add('btn-warning');
                unlimitedBtn.innerHTML = '<i class="fas fa-check"></i> Unlimited ON';
                pathsHint.style.display = 'none';
                unlimitedWarning.style.display = 'block';
            } else {
                // Disable unlimited mode
                maxPathsInput.value = 50;
                maxPathsInput.disabled = false;
                maxPathsInput.style.backgroundColor = '';
                unlimitedBtn.classList.remove('btn-warning');
                unlimitedBtn.classList.add('btn-outline-warning');
                unlimitedBtn.innerHTML = '<i class="fas fa-infinity"></i> Unlimited';
                pathsHint.style.display = 'block';
                unlimitedWarning.style.display = 'none';
            }
        }
        
        // Initialize on page load to set unlimited mode as default
        document.addEventListener('DOMContentLoaded', function() {
            const maxPathsInput = document.getElementById('maxPaths');
            maxPathsInput.disabled = true;
            maxPathsInput.style.backgroundColor = '#fff3cd';
        });
        // Enhanced scan functionality with real-time updates
        document.getElementById('scanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('targetUrl').value;
            const timeout = document.getElementById('timeout').value;
            const maxPaths = document.getElementById('maxPaths').value;
            const maxScanTime = document.getElementById('maxScanTime').value;
            
            // Confirmation for unlimited mode
            if (isUnlimitedMode) {
                if (!confirm('‚ö†Ô∏è UNLIMITED MODE: This scan will test ALL discovered paths and may take a very long time. Continue?')) {
                    return;
                }
            }
            
            const requestData = {
                url: url, 
                timeout: parseInt(timeout),
                max_paths: parseInt(maxPaths)
            };
            
            // Add max_scan_time only if specified
            if (maxScanTime) {
                requestData.max_scan_time = parseInt(maxScanTime) * 60;  // Convert minutes to seconds
            }
            
            fetch('/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.scan_id) {
                    createScanMonitor(data.scan_id, url);
                } else {
                    alert('Error starting scan: ' + (data.error || 'Unknown error'));
                }
            });
        });

        function createScanMonitor(scanId, url) {
            const activeScansDiv = document.getElementById('activeScans');
            
            const scanCard = document.createElement('div');
            scanCard.className = 'card mb-3';
            scanCard.id = 'scan-' + scanId;
            scanCard.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Scan ${scanId}</strong> - ${url}
                    </div>
                    <div class="btn-group" role="group" style="display: none;" id="actions-${scanId}">
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadReport('${scanId}', 'json')">JSON</button>
                        <button class="btn btn-sm btn-outline-success" onclick="downloadReport('${scanId}', 'csv')">CSV</button>
                        <button class="btn btn-sm btn-outline-info" onclick="downloadReport('${scanId}', 'markdown')">MD</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="progress mb-2">
                        <div class="progress-bar" id="progress-${scanId}" style="width: 0%"></div>
                    </div>
                    <div id="status-${scanId}">Initializing...</div>
                    <div id="results-${scanId}" style="display: none;"></div>
                </div>
            `;
            
            activeScansDiv.appendChild(scanCard);
            
            // Start monitoring
            monitorScan(scanId);
        }

        function monitorScan(scanId) {
            const interval = setInterval(() => {
                fetch(`/api/scan/${scanId}/status`)
                .then(response => response.json())
                .then(data => {
                    updateScanProgress(scanId, data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        if (data.status === 'completed') {
                            loadScanResults(scanId);
                        }
                    }
                });
            }, 2000);
        }

        function updateScanProgress(scanId, data) {
            const progressBar = document.getElementById('progress-' + scanId);
            const statusDiv = document.getElementById('status-' + scanId);
            
            if (progressBar) progressBar.style.width = (data.progress || 0) + '%';
            
            let statusText = data.stage || data.status || 'Unknown';
            if (data.elapsed_time) statusText += ` (${data.elapsed_time})`;
            if (data.vulnerabilities_found !== undefined) {
                statusText += ` - ${data.vulnerabilities_found} vulnerabilities found`;
            }
            
            if (statusDiv) statusDiv.textContent = statusText;
            
            if (data.status === 'completed') {
                document.getElementById('actions-' + scanId).style.display = 'block';
            }
        }

        function loadScanResults(scanId) {
            fetch(`/api/scan/${scanId}/results`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('results-' + scanId);
                if (data.vulnerabilities) {
                    let html = '<h6>Scan Results:</h6>';
                    html += `<p><strong>Total Vulnerabilities:</strong> ${data.vulnerabilities.length}</p>`;
                    
                    if (data.summary) {
                        html += '<strong>By Severity:</strong><br>';
                        for (const [severity, count] of Object.entries(data.summary.by_severity)) {
                            const badgeClass = severity === 'CRITICAL' ? 'danger' : 
                                              severity === 'HIGH' ? 'warning' : 
                                              severity === 'MEDIUM' ? 'info' : 'secondary';
                            html += `<span class="badge bg-${badgeClass} me-1">${severity}: ${count}</span>`;
                        }
                    }
                    
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                }
            });
        }

        function downloadReport(scanId, format) {
            if (!scanId || scanId === '') {
                alert('Scan ID n√£o encontrado. Execute um scan primeiro.');
                return;
            }
            console.log(`Downloading report for scan: ${scanId}, format: ${format}`);
            window.open(`/api/scan/${scanId}/report/${format}`, '_blank');
        }

        // Chart and Filter functionality
        let vulnerabilityChart = null;
        let riskChart = null;
        let currentFilter = 'all';

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
        });

        function initCharts() {
            // Vulnerability Distribution Pie Chart
            const ctx1 = document.getElementById('vulnerabilityChart').getContext('2d');
            vulnerabilityChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk', 'Info'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#17a2b8']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Risk Trend Line Chart
            const ctx2 = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Vulnerabilities Found',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function loadDashboardData() {
            fetch('/api/dashboard/stats', {
                method: 'GET',
                credentials: 'same-origin',  // Include cookies for session
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('API call failed');
                    }
                })
                .then(data => {
                    console.log('Dashboard data loaded:', data);
                    updateCharts(data);
                })
                .catch(error => {
                    console.log('Dashboard data not available, using demo data:', error);
                    updateChartsWithDemoData();
                });
        }

        function updateCharts(data) {
            if (!vulnerabilityChart || !riskChart) return;

            // Update vulnerability distribution
            vulnerabilityChart.data.datasets[0].data = [
                data.high_risk || 15,
                data.medium_risk || 28,
                data.low_risk || 42,
                data.info || 8
            ];
            vulnerabilityChart.update();

            // Update risk trend
            riskChart.data.labels = data.trend_labels || ['Scan 1', 'Scan 2', 'Scan 3', 'Scan 4', 'Scan 5'];
            riskChart.data.datasets[0].data = data.trend_data || [12, 19, 8, 25, 15];
            riskChart.update();
        }

        function updateChartsWithDemoData() {
            if (!vulnerabilityChart || !riskChart) return;

            // Demo vulnerability distribution
            vulnerabilityChart.data.datasets[0].data = [15, 28, 42, 8];
            vulnerabilityChart.update();

            // Demo risk trend
            riskChart.data.labels = ['Last Week', 'This Week', 'Today'];
            riskChart.data.datasets[0].data = [12, 19, 25];
            riskChart.update();
        }

        function filterScans(filter) {
            currentFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            // Find and activate the clicked button
            const clickedButton = Array.from(document.querySelectorAll('.btn-group .btn')).find(btn => {
                return btn.textContent.trim().toLowerCase() === filter || 
                       (filter === 'all' && btn.textContent.trim() === 'All') ||
                       (filter === 'completed' && btn.textContent.trim() === 'Completed') ||
                       (filter === 'running' && btn.textContent.trim() === 'Running') ||
                       (filter === 'failed' && btn.textContent.trim() === 'Failed');
            });
            
            if (clickedButton) {
                clickedButton.classList.remove('btn-outline-primary');
                clickedButton.classList.add('btn-primary');
            }

            // Filter table rows
            const tableBody = document.querySelector('#scanHistory');
            if (tableBody) {
                const tableRows = tableBody.querySelectorAll('tr');
                tableRows.forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else {
                        const statusBadge = row.querySelector('.badge');
                        if (statusBadge) {
                            const status = statusBadge.textContent.trim().toLowerCase();
                            row.style.display = status === filter ? '' : 'none';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                console.log(`Filtered ${tableRows.length} rows for: ${filter}`);
            } else {
                console.log('Table body #scanHistory not found');
            }
        }

        // Force header visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Checking header visibility...');
            const navbar = document.querySelector('.navbar');
            const dashboardHeader = document.querySelector('.dashboard-header');
            
            if (navbar) {
                navbar.style.display = 'block';
                navbar.style.visibility = 'visible';
                navbar.style.opacity = '1';
                navbar.style.position = 'static';
                navbar.style.width = '100%';
                console.log('‚úÖ Navbar forced to be visible');
            } else {
                console.log('‚ùå Navbar element not found!');
            }
            
            if (dashboardHeader) {
                dashboardHeader.style.display = 'block';
                dashboardHeader.style.visibility = 'visible';
                dashboardHeader.style.opacity = '1';
                console.log('‚úÖ Dashboard header forced to be visible');
            } else {
                console.log('‚ùå Dashboard header element not found!');
            }
        });
    </script>
</body>
</html>